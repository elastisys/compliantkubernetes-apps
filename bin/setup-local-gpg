#!/usr/bin/env bash
set -euo pipefail

GNUPGHOME="$(mktemp -d)"
export GNUPGHOME

cat >"$GNUPGHOME/gpg-batch" <<EOF
%echo Generating a basic OpenPGP key
Key-Type: RSA
Key-Length: 4096
Name-Real: Local Test User
Name-Email: local-test@welkin.test
Expire-Date: 0
%no-protection
%commit
%echo done
EOF

gpg --batch --generate-key "$GNUPGHOME/gpg-batch" >/dev/null 2>&1

# SOPS needs this fingerprint to know which key to use
FINGERPRINT=$(gpg --list-secret-keys --keyid-format LONG | grep sec | awk '{print $2}' | cut -d'/' -f2)

echo "export GNUPGHOME='$GNUPGHOME'"
echo "export CK8S_PGP_FP='$FINGERPRINT'"
