# Upgrade v0.28.x to v0.29.x

## Prerequisites

- [ ] Notify the users (if any) before the upgrade starts;
- [ ] Check if there are any pending changes to the environment;
- [ ] Check the state of the environment, pods, nodes and backup jobs:

    ```bash
    ./bin/ck8s test sc|wc
    ./bin/ck8s ops kubectl sc|wc get pods -A -o custom-columns=NAMESPACE:metadata.namespace,POD:metadata.name,READY-false:status.containerStatuses[*].ready,REASON:status.containerStatuses[*].state.terminated.reason | grep false | grep -v Completed
    ./bin/ck8s ops kubectl sc|wc get nodes
    ./bin/ck8s ops kubectl sc|wc get jobs -A
    velero get backup
    ```

- [ ] Silence the notifications for the alerts. e.g you can use [alertmanager silences](https://prometheus.io/docs/alerting/latest/alertmanager/#silences);

## Steps that can be done before the upgrade - non-disruptive

1. Pull the latest changes and switch to the correct branch:

    ```bash
    git pull
    git switch -d v0.29.0
    ```

1. Update apps configuration:

    This will take a backup into `backups/` before modifying any files.

    ```bash
    ./bin/ck8s init
    ```

1. Reconfigure fluentd:

    ```bash
    ./migration/v0.28.x-v0.29.x/reconfigure-fluentd.sh
    ```

    *Optional:*
    Fluentd can now collect audit logs, enable it by setting `fluentd.audit.enable: true`.
    Make sure to create the bucket as set by `objectStore.buckets.audit` to store those logs.

    ```bash
    ./scripts/S3/entry.sh --s3cfg "$CK8S_CONFIG_PATH/.state/s3cfg.ini" create
    ```

1. **Warning** The default Gatekeeper enforcements have been updated:

    - Disallow latest tag `disallowedTags.enforcement` default is now `deny` - was `dryrun`
    - Require trusted image registry `imageRegistry.enforcement` default is now `warn` - was `deny`
    - Require network policies `networkPolicies.enforcement` default is now `warn` - was `deny`
    - Require resource requests `resourceRequests.enforcement` default is unchanged as `deny`

    As changing these enforcements can be disruptive, especially when going from `dryrun` to `deny`, here are some recommendations:

    - If the new default is `deny` and the environment does not already have `deny` on that specific policy, then override with `warn` and inform the user that they should work toward being able to have `deny` in the future.
    - If the new default is `warn` and the environment has `deny`, then leave it at `deny` (possibly requiring an override config).
    - If the new default is `warn` and the environment has `dryrun`, then use `warn` (possibly requiring removal of override config) and inform the user that they will start seeing warnings from that policy.

## Upgrade steps

1. Run bootstrap to create `fluentd-system` namespaces:

    ```bash
    ./bin/ck8s bootstrap sc
    ./bin/ck8s bootstrap wc
    ```

1. Redeploy fluentd:

    This will remove the old fluentd releases in both SC and WC, install the new releases and update the rest.

    ```bash
    ./migration/v0.28.x-v0.29.x/redeploy-fluentd.sh
    ```

1. Remove the old metrics-server components from the clusters:

   ```bash
   ./migration/v0.28.x-v0.29.x/remove_old_metrics_server.sh
   ```

1. Before upgrading, destroy `kured` in sc & wc
    ```bash
    ./bin/ck8s ops helmfile sc -l app=kured destroy
    ./bin/ck8s ops helmfile wc -l app=kured destroy
    ```

1. Upgrade starboard-operator CRDs

    ```bash
    ./bin/ck8s ops kubectl wc apply -f ./helmfile/upstream/starboard-operator/crds/
    ./bin/ck8s ops kubectl sc apply -f ./helmfile/upstream/starboard-operator/crds/
    ```

1. Upgrade applications:

    ```bash
    ./bin/ck8s apply {sc|wc}
    ```

## Postrequisite:

- [ ] Check the state of the environment, pods and nodes:

    ```bash
    ./bin/ck8s test sc|wc
    ./bin/ck8s ops kubectl sc|wc get pods -A -o custom-columns=NAMESPACE:metadata.namespace,POD:metadata.name,READY-false:status.containerStatuses[*].ready,REASON:status.containerStatuses[*].state.terminated.reason | grep false | grep -v Completed
    ./bin/ck8s ops kubectl sc|wc get nodes
    ```

- [ ] Enable the notifications for the alerts;
- [ ] Notify the users (if any) when the upgrade is complete;

> **_Note:_** Additionally it is good to check:

- if any alerts generated by the upgrade didn't close;
- if you can login to Grafana, Opensearch or Harbor;
- you can see fresh metrics and logs.
