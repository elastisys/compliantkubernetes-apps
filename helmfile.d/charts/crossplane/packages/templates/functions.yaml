{{- range $name, $values := .Values.functions }}
{{- if gt (len (printf "function-%s" $name)) 63 }}
{{- printf "function name is too long 'function-%s', needs to be maximum 63 characters" $name | fail }}
{{- end }}
---
apiVersion: pkg.crossplane.io/v1beta1
kind: Function
metadata:
  name: function-{{ $name }}
spec:
  package: {{ $values.image.repository }}:{{ $values.image.tag }}
  runtimeConfigRef:
    apiVersion: pkg.crossplane.io/v1beta1
    kind: DeploymentRuntimeConfig
    name: function-{{ $name }}
---
apiVersion: pkg.crossplane.io/v1beta1
kind: DeploymentRuntimeConfig
metadata:
  name: function-{{ $name }}
spec:
  deploymentTemplate:
    spec:
      selector: {}
      template:
        spec:
          securityContext:
            runAsNonRoot: true
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: package-runtime
              securityContext:
                allowPrivilegeEscalation: false
                capabilities:
                  drop:
                    - ALL
                runAsUser: 65532
{{- end }}
