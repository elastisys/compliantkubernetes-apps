---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: fetch-version
spec:
  results:
    - name: devbox-image-tag
      description: The devbox image tag to use based on the README.md of the config repository
    - name: kubespray-version
      description: The kubespray version
    - name: apps-version
      description: The apps version
  workspaces:
  - name: source
  steps:
    - name: main
      image: {{ .Values.tekton.pipeline.devbox.repository }}:{{ .Values.tekton.pipeline.devbox.tag }}
      env:
        - name: "CK8S_CONFIG_PATH"
          value: $(workspaces.source.path)/config
      script: |
        #!/usr/bin/env bash

        if [[ ! -f "${CK8S_CONFIG_PATH}/README.md" ]]; then
            echo "error: could not find ${CK8S_CONFIG_PATH}/README.md"
            exit 1
        fi

        kubespray_version="$(grep -o '\[compliantkubernetes-kubespray@v[0-9]*\.[0-9]*\.[0-9]*-ck8s[0-9]*\]' "${CK8S_CONFIG_PATH}/README.md" | sed -e 's/^\[compliantkubernetes-kubespray@v//' -e 's/\]$//' -e 's/-ck8s/\./')"
        apps_version="$(grep -o '\[compliantkubernetes-apps@v[0-9]*\.[0-9]*\.[0-9]*\]' "${CK8S_CONFIG_PATH}/README.md" | sed -e 's/^\[compliantkubernetes-apps@v//' -e 's/\]$//')"

        error="false"

        if [[ -z "${kubespray_version}" ]]; then
            echo "error: could not parse kubespray version, found $(grep -o '\[compliantkubernetes-kubespray@.*\]' "${CK8S_CONFIG_PATH}/README.md")"
            error="true"
        fi
        if [[ -z "${apps_version}" ]]; then
            echo "error: could not parse apps version, found $(grep -o '\[compliantkubernetes-apps@.*\]' "${CK8S_CONFIG_PATH}/README.md")"
            error="true"
        fi
        if [[ "${error}" == "true" ]]; then
            exit 1
        fi

        echo "ck8s-devbox@a${apps_version}-k${kubespray_version}"
        echo
        echo "compliantkubernetes-kubespray@${kubespray_version}"
        echo "compliantkubernetes-apps@${apps_version}"

        echo -n "a${apps_version}-k${kubespray_version}" | tee "$(results.devbox-image-tag.path)"
        echo -n "${kubespray_version}" | tee "$(results.kubespray-version.path)"
        echo -n "${apps_version}" | tee "$(results.apps-version.path)"

      securityContext:
        runAsNonRoot: true
        runAsGroup: 65532
        runAsUser: 65532
