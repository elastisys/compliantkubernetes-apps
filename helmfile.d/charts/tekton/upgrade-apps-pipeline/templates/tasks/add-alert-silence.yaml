---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: add-alert-silence
spec:
  results:
    - name: silence-id
      description: The ID of the silence created in alertmanager
  workspaces:
  - name: source
  params:
    - name: devbox-image-tag
      description: The devbox image tag to use based on the README.md of the config repository
      type: string
      default: {{ .Values.tekton.pipeline.devbox.tag | quote }}
  steps:
    - name: add-alert-silence
      image: {{ .Values.tekton.pipeline.devbox.repository }}:$(inputs.params.devbox-image-tag)
      {{- with .Values.tekton.pipeline.resources }}
      resources:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      env:
        - name: "CK8S_CONFIG_PATH"
          value: $(workspaces.source.path)/config
      script: |
        #!/usr/bin/env bash

        echo "Adding a 2 hour alert silence"

        silence_id=$(kubectl --kubeconfig ${CK8S_CONFIG_PATH}/.state/kube_config_sc.yaml exec -n monitoring statefulset/alertmanager-kube-prometheus-stack-alertmanager -it -c alertmanager -- amtool --alertmanager.url=http://localhost:9093 silence add 'alertname=~".+"' -d 120m --comment="Maintenance silence")

        echo ${silence_id} | tee "$(results.silence-id.path)"

      securityContext:
        runAsNonRoot: true
        runAsGroup: 65532
        runAsUser: 65532
      volumeMounts:
        - name: kubeconfigs
          mountPath: $(workspaces.source.path)/config/.state/kube_config_sc.yaml
          subPath: kube_config_sc.yaml
  volumes:
    - name: kubeconfigs
      secret:
        secretName: kubeconfigs
