---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: remove-sa-rbac
spec:
  workspaces:
  - name: source
  params:
    - name: devbox-image-tag
      description: The devbox image tag to use based on the README.md of the config repository
      type: string
      default: {{ .Values.tekton.pipeline.devbox.tag | quote }}
  steps:
    - name: remove-sa-rbac
      image: {{ .Values.tekton.pipeline.devbox.repository }}:$(inputs.params.devbox-image-tag)
      {{- with .Values.tekton.pipeline.resources }}
      resources:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      env:
        - name: "CK8S_CONFIG_PATH"
          value: $(workspaces.source.path)/config
      script: |
        #!/usr/bin/env bash

        echo "Deleting ClusterRoleBinding {{ .Values.tekton.service.serviceAccount.name }} in SC Cluster"
        kubectl --kubeconfig ${CK8S_CONFIG_PATH}/.state/kube_config_sc.yaml delete ClusterRoleBinding {{ .Values.tekton.service.serviceAccount.name }}
        echo "Deleting ClusterRoleBinding {{ .Values.tekton.workload.serviceAccount.name }} in WC Cluster"
        kubectl --kubeconfig ${CK8S_CONFIG_PATH}/.state/kube_config_wc.yaml delete ClusterRoleBinding {{ .Values.tekton.workload.serviceAccount.name }}

      securityContext:
        runAsNonRoot: true
        runAsGroup: 65532
        runAsUser: 65532
      volumeMounts:
        - name: kubeconfigs
          mountPath: $(workspaces.source.path)/config/.state/kube_config_sc.yaml
          subPath: kube_config_sc.yaml
        - name: kubeconfigs
          mountPath: $(workspaces.source.path)/config/.state/kube_config_wc.yaml
          subPath: kube_config_wc.yaml
  volumes:
    - name: kubeconfigs
      secret:
        secretName: kubeconfigs
