---
templates:
  tekton:
    condition: ck8sManagementCluster.enabled
    namespace: tekton-pipelines

  tekton-rbac:
    name: tekton-rbac
    namespace: kube-system
    labels:
      app: tekton-rbac
      stage: bootstrap
    chart: charts/tekton/tekton-rbac
    version: 0.1.0
    installed: {{ .Values | get "tekton.enabled" false }}
    values:
    {{- if .Values | get "ck8sManagementCluster.enabled" false }}
      - values/tekton/bootstrap/service/tekton-rbac.yaml.gotmpl
    {{- else if .Values | get "ck8sWorkloadCluster.enabled" false }}
      - values/tekton/bootstrap/workload/tekton-rbac.yaml.gotmpl
    {{- end  }}

  tekton-pipelines:
    inherit:
      - template: tekton
    name: tekton-pipelines
    labels:
      app: tekton-pipelines
      stage: setup
    chart: charts/tekton/tekton-pipelines
    installed: {{ and (.Values | get "tekton.enabled" false) (.Values | get "tekton.components.pipelines.enabled" false) }}
    version: 0.1.0

  tekton-dashboard:
    inherit:
      - template: tekton
    name: tekton-dashboard
    labels:
      app: tekton-dashboard
      stage: setup
    chart: charts/tekton/tekton-dashboard
    version: 0.2.2
    installed: {{ and (.Values | get "tekton.enabled" false) (.Values | get "tekton.components.dashboard.enabled" false) }}

  tekton-triggers:
    inherit:
      - template: tekton
    name: tekton-triggers
    labels:
      app: tekton-triggers
      stage: setup
    chart: charts/tekton/tekton-triggers
    version: 0.1.0
    disableValidation: true
    installed: {{ and (.Values | get "tekton.enabled" false) (.Values | get "tekton.components.triggers.enabled" false) }}

  tekton-chains:
    inherit:
      - template: tekton
    name: tekton-chains
    labels:
      app: tekton-chains
      stage: setup
    chart: charts/tekton/tekton-chains
    version: 0.1.0
    installed: {{ and (.Values | get "tekton.enabled" false) (.Values | get "tekton.components.chains.enabled" false) }}

  upgrade-apps-pipeline:
    inherit:
      - template: tekton
    name: upgrade-apps-pipeline
    labels:
      app: upgrade-apps-pipeline
      stage: setup
    chart: charts/tekton/upgrade-apps-pipeline
    version: 0.1.0
    disableValidation: true
    installed: {{ and (.Values | get "tekton.enabled" false) (.Values | get "tekton.components.upgradeApps.enabled" false) }}
    values:
      - values/tekton/upgrade-apps.yaml.gotmpl
      - values/tekton/cleanup.yaml.gotmpl
    needs:
      - tekton-pipelines/tekton-pipelines
      {{- if .Values | get "tekton.listener.enabled" false }}
      - tekton-pipelines/tekton-triggers
      {{- end }}
