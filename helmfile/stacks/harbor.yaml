---
templates:
  harbor:
    condition: ck8sManagementCluster.enabled
    namespace: harbor
    labels:
      app: harbor

  harbor-networkpolicy:
    inherit:
      - template: harbor
      - template: networkpolicies
    installed: {{ and (.Values | get "harbor.enabled" false) (.Values | get "networkPolicies.harbor.enabled" false) }}
    labels:
      netpol: harbor
    values:
      - helmfile/values/networkpolicies/common/common.yaml.gotmpl
      - helmfile/values/networkpolicies/service/harbor.yaml.gotmpl

  harbor-podsecuritypolicy:
    inherit:
      - template: harbor
      - template: podsecuritypolicies
    installed: {{ .Values | get "harbor.enabled" false }}
    labels:
      psp: harbor
    values:
      - helmfile/values/podsecuritypolicies/service/harbor.yaml.gotmpl

  harbor-certs:
    disableValidationOnInstall: true # creates cert-manager/certificates and cert-manager/issuers
    inherit: [ template: harbor ]
    installed: {{ .Values | get "harbor.enabled" false }}
    chart: helmfile/charts/harbor/harbor-certs
    version: 0.1.0
    name: harbor-certs
    needs:
      - cert-manager/cert-manager
    values:
      - helmfile/values/harbor/harbor-certs.yaml.gotmpl

  harbor-main:
    inherit:
      - template: harbor
      - template: harbor-chart
    installed: {{ .Values | get "harbor.enabled" false }}
    name: harbor
    needs:
      - harbor/harbor-certs
      - harbor/networkpolicy
      - harbor/podsecuritypolicy
    values:
      - helmfile/values/harbor/harbor.yaml.gotmpl
    wait: true

  harbor-init:
    inherit: [ template: harbor ]
    installed: {{ .Values | get "harbor.enabled" false }}
    chart: helmfile/charts/harbor/init-harbor
    version: 0.2.0
    name: init-harbor
    needs:
      - harbor/harbor
      - harbor/networkpolicy
      - harbor/podsecuritypolicy
    values:
      - helmfile/values/harbor/init-harbor.yaml.gotmpl

  harbor-backup:
    inherit: [ template: harbor ]
    installed: {{ .Values | get "harbor.enabled" false }}
    chart: helmfile/charts/harbor/harbor-backup
    version: 0.1.0
    name: harbor-backup
    needs:
      - harbor/harbor
      - harbor/networkpolicy
      - harbor/podsecuritypolicy
    values:
      - helmfile/values/harbor/harbor-backup.yaml.gotmpl
