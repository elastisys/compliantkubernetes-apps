---
templates:
  opensearch:
    condition: ck8sManagementCluster.enabled
    namespace: opensearch-system
    labels:
      app: opensearch

  opensearch-podsecuritypolicy:
    inherit:
      - template: opensearch
      - template: podsecuritypolicies
    labels:
      psp: opensearch
    values:
      - helmfile/values/podsecuritypolicies/service/opensearch.yaml.gotmpl

  opensearch-secrets:
    disableValidationOnInstall: true # creates cert-manager/certificates
    inherit: [ template: opensearch ]
    installed: {{ .Values | get "opensearch.enabled" false }}
    chart: helmfile/charts/opensearch/secrets
    version: 0.1.0
    name: opensearch-secrets
    needs:
      - cert-manager/cert-manager
    values:
      - helmfile/values/opensearch/secrets.yaml.gotmpl

  opensearch-master:
    disableValidationOnInstall: true
    inherit:
      - template: opensearch
      - template: opensearch-chart
    name: opensearch-master
    needs:
      {{- if .Values | get "opensearch.sso.enabled" false }}
      # - dex/dex
      {{- end }}
      - kube-system/service-cluster-np
      - opensearch-system/opensearch-secrets
      - opensearch-system/podsecuritypolicy
    values:
      - helmfile/values/opensearch/common.yaml.gotmpl
      - helmfile/values/opensearch/master.yaml.gotmpl
    wait: true

  opensearch-client:
    inherit:
      - template: opensearch
      - template: opensearch-chart
    installed: {{ and ( .Values | get "opensearch.enabled" false) (.Values | get "opensearch.clientNode.dedicatedPods" false) }}
    name: opensearch-client
    needs:
      - kube-system/service-cluster-np
      - opensearch-system/opensearch-master
      - opensearch-system/podsecuritypolicy
    values:
      - helmfile/values/opensearch/common.yaml.gotmpl
      - helmfile/values/opensearch/client.yaml.gotmpl

  opensearch-data:
    inherit:
      - template: opensearch
      - template: opensearch-chart
    installed: {{ and ( .Values | get "opensearch.enabled" false) (.Values | get "opensearch.dataNode.dedicatedPods" false) }}
    name: opensearch-data
    needs:
      - kube-system/service-cluster-np
      - opensearch-system/opensearch-master
      - opensearch-system/podsecuritypolicy
    values:
      - helmfile/values/opensearch/common.yaml.gotmpl
      - helmfile/values/opensearch/data.yaml.gotmpl

  opensearch-dashboards:
    inherit:
      - template: opensearch
      - template: opensearch-dashboards-chart
    name: opensearch-dashboards
    needs:
      - kube-system/service-cluster-np
      - opensearch-system/opensearch-master
      - opensearch-system/podsecuritypolicy
    values:
      - helmfile/values/opensearch/dashboards.yaml.gotmpl
    wait: true

  opensearch-securityadmin:
    inherit: [ template: opensearch ]
    installed: {{ and ( .Values | get "opensearch.enabled" false) (.Values | get "opensearch.securityadmin.enabled" false) }}
    chart: helmfile/charts/opensearch/securityadmin
    version: 0.1.0
    name: opensearch-securityadmin
    needs:
      - opensearch-system/opensearch-master
    values:
      - helmfile/values/opensearch/securityadmin.yaml.gotmpl

  opensearch-configurer:
    inherit: [ template: opensearch ]
    chart: helmfile/charts/opensearch/configurer
    version: 0.1.0
    name: opensearch-configurer
    needs:
      {{- if .Values | get "opensearch.securityadmin.enabled" false }}
      - opensearch-system/opensearch-securityadmin
      {{- else }}
      - opensearch-system/opensearch-master
      {{- end }}
      - opensearch-system/opensearch-dashboards
    values:
      - helmfile/values/opensearch/securityadmin.yaml.gotmpl
      - helmfile/values/opensearch/configurer.yaml.gotmpl

  opensearch-backup:
    inherit: [ template: opensearch ]
    installed: {{ and ( .Values | get "opensearch.enabled" false) (.Values | get "opensearch.snapshot.enabled" false) }}
    chart: helmfile/charts/opensearch/backup
    version: 0.1.0
    name: opensearch-backup
    needs:
      - opensearch-system/opensearch-configurer
    values:
      - helmfile/values/opensearch/backup.yaml.gotmpl

  opensearch-slm:
    inherit: [ template: opensearch ]
    installed: {{ and ( .Values | get "opensearch.enabled" false) (.Values | get "opensearch.snapshot.enabled" false) }}
    chart: helmfile/charts/opensearch/slm
    version: 0.1.0
    name: opensearch-slm
    needs:
      - opensearch-system/opensearch-configurer
    values:
      - helmfile/values/opensearch/slm.yaml.gotmpl

  opensearch-curator:
    inherit: [ template: opensearch ]
    installed: {{ and ( .Values | get "opensearch.enabled" false) (.Values | get "opensearch.curator.enabled" false) }}
    chart: helmfile/charts/opensearch/curator
    version: 0.1.0
    name: opensearch-curator
    needs:
      - opensearch-system/opensearch-configurer
    values:
      - helmfile/values/opensearch/curator.yaml.gotmpl

  opensearch-exporter:
    disableValidationOnInstall: true # creates prometheus-operator/servicemonitors
    inherit:
      - template: opensearch
      - template: prometheus-elasticsearch-exporter-chart
    name: prometheus-opensearch-exporter
    needs:
      # - monitoring/kube-prometheus-stack
      - opensearch-system/opensearch-configurer
    values:
      - helmfile/values/prometheus-opensearch-exporter.yaml.gotmpl
