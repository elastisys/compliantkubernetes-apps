---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vulnerability-exporter-script
data:
  cronjob: |
    ### cron file for running the export script
    #{{ .Values.vulnerabilityExporter.schedule }} sh /scripts/convert-vulnerabilityreports.sh
    # An empty line is required at the end of this file for a valid cron file.
  convert-vulnerabilityreports.sh: |
    #!/bin/sh

    APISERVER=https://kubernetes.default.svc
    SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount
    NAMESPACE=$(cat ${SERVICEACCOUNT}/namespace)
    TOKEN=$(cat ${SERVICEACCOUNT}/token)
    CACERT=${SERVICEACCOUNT}/ca.crt
    curl --cacert ${CACERT} --header "Authorization: Bearer ${TOKEN}" --silent -X GET ${APISERVER}/apis/aquasecurity.github.io/v1alpha1/vulnerabilityreports > /textfile-collector/tmp-reports.json
    cat /textfile-collector/tmp-reports.json
    cat /textfile-collector/tmp-reports.json | jq '.items[] | {name: .metadata.name, namespace: .metadata.namespace, severity: "low", result: .report.summary.lowCount}' -c | sed 's/,"result":\([0-9]\+\)}/} \1/' | sed 's/^/image_vulnerability/' | sed 's/"\([a-z]\+\)":/\1=/g' > /textfile-collector/tmp-metrics
    cat /textfile-collector/tmp-reports.json | jq '.items[] | {name: .metadata.name, namespace: .metadata.namespace, severity: "medium", result: .report.summary.mediumCount}' -c | sed 's/,"result":\([0-9]\+\)}/} \1/' | sed 's/^/image_vulnerability/' | sed 's/"\([a-z]\+\)":/\1=/g' >> /textfile-collector/tmp-metrics
    cat /textfile-collector/tmp-reports.json | jq '.items[] | {name: .metadata.name, namespace: .metadata.namespace, severity: "high", result: .report.summary.highCount}' -c | sed 's/,"result":\([0-9]\+\)}/} \1/' | sed 's/^/image_vulnerability/' | sed 's/"\([a-z]\+\)":/\1=/g' >> /textfile-collector/tmp-metrics
    cat /textfile-collector/tmp-reports.json | jq '.items[] | {name: .metadata.name, namespace: .metadata.namespace, severity: "critical", result: .report.summary.criticalCount}' -c | sed 's/,"result":\([0-9]\+\)}/} \1/' | sed 's/^/image_vulnerability/' | sed 's/"\([a-z]\+\)":/\1=/g' >> /textfile-collector/tmp-metrics
    cat /textfile-collector/tmp-reports.json | jq '.items[] | {name: .metadata.name, namespace: .metadata.namespace, severity: "unknown", result: .report.summary.unknownCount}' -c | sed 's/,"result":\([0-9]\+\)}/} \1/' | sed 's/^/image_vulnerability/' | sed 's/"\([a-z]\+\)":/\1=/g' >> /textfile-collector/tmp-metrics
    cat /textfile-collector/tmp-metrics > /textfile-collector/vulnerabilities.prom
    cat /textfile-collector/tmp-metrics
