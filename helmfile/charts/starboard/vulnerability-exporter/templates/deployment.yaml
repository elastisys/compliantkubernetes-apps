apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: vulnerability-exporter
  name: vulnerability-exporter
spec:
  replicas: 1
  selector:
    matchLabels:
      app: vulnerability-exporter
  template:
    metadata:
      labels:
        app: vulnerability-exporter
    spec:
      serviceAccountName: vulnerability-exporter
      containers:
      - name: metrics-collector
        image: ghcr.io/elastisys/user-crontab:v0.1.0
        securityContext:
          allowPrivilegeEscalation: true
          runAsUser: 1000
          runAsGroup: 1000
        volumeMounts:
          - name: textfile-collector-dir
            mountPath: /textfile-collector
          - name: scripts
            mountPath: /scripts
        resources: {{- .Values.curlcronjob.resources | toYaml | nindent 10 }}
      - name: node-exporter
        image: prom/node-exporter:v1.0.1
        args:
          - --collector.textfile.directory=/textfile-collector
          - --no-collector.arp
          - --no-collector.bcache
          - --no-collector.bonding
          - --no-collector.conntrack
          - --no-collector.cpu
          - --no-collector.cpufreq
          - --no-collector.diskstats
          - --no-collector.edac
          - --no-collector.entropy
          - --no-collector.filefd
          - --no-collector.filesystem
          - --no-collector.hwmon
          - --no-collector.infiniband
          - --no-collector.ipvs
          - --no-collector.loadavg
          - --no-collector.mdadm
          - --no-collector.meminfo
          - --no-collector.netclass
          - --no-collector.netdev
          - --no-collector.nfs
          - --no-collector.nfsd
          - --no-collector.netstat
          - --no-collector.pressure
          - --no-collector.stat
          - --no-collector.sockstat
          - --no-collector.timex
          - --no-collector.vmstat
          - --no-collector.xfs
          - --no-collector.zfs
          - --no-collector.btrfs
          - --no-collector.powersupplyclass
          - --no-collector.rapl
          - --no-collector.schedstat
          - --no-collector.softnet
          - --no-collector.thermal_zone
          - --no-collector.time
          - --no-collector.udp_queues
          - --no-collector.uname
          # enabled collectors: textfile, time, uname
        ports:
        - containerPort: 9100
          name: metrics
        volumeMounts:
          - name: textfile-collector-dir
            mountPath: /textfile-collector
        resources: {{- .Values.resources | toYaml | nindent 10 }}
      volumes:
      - name: textfile-collector-dir
        emptyDir: {}
      - name: scripts
        configMap:
          name: vulnerability-exporter-script
      {{- if .Values.tolerations }}
      tolerations:
{{ toYaml .Values.tolerations | indent 8 }}
      {{- end }}
      {{- if .Values.affinity }}
      affinity:
{{ toYaml .Values.affinity | indent 8 }}
      {{- end }}
