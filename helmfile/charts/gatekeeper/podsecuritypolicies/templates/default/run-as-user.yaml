apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPAllowedUsers
metadata:
  name: restricted-run-as-user
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaces:
    {{- range $namespace, $services := .Values.constraints }}
      - {{ $namespace }}
    {{- end}}
    labelSelector:
      matchExpressions:
        {{- range $namespace,$services := .Values.constraints }}
          {{- range $name, $value := $services }}
            {{- if or (hasKey $value.allow "runAsUser") (hasKey $value.allow "runAsGroup") (hasKey $value.allow "supplementalGroups") (hasKey $value.allow "fsGroup") }}
              {{- range $labelkey, $labelvalue := $value.podSelectorLabels }}
        - key: {{ $labelkey }}
          operator: NotIn
          values:
            - {{ $labelvalue | quote }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
  parameters:
    runAsUser:
      rule: MustRunAsNonRoot
    runAsGroup:
      rule: MustRunAs
      ranges:
        - max: 65535
          min: 1
    supplementalGroups:
      rule: MustRunAs
      ranges:
        - max: 65535
          min: 1
    fsGroup:
      rule: MustRunAs
      ranges:
        - max: 65535
          min: 1
