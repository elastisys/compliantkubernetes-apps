apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPVolumeTypes
metadata:
  name: restricted-volumes
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
    namespaces:
    {{- range $namespace, $services := .Values.constraints }}
      - {{ $namespace }}
    {{- end}}
    labelSelector:
      matchExpressions:
        {{- range $namespace,$services := .Values.constraints }}
          {{- range $name, $value := $services }}
            {{- if hasKey $value.allow "volumes" }}
              {{- range $labelkey, $labelvalue := $value.podSelectorLabels }}
        - key: {{ $labelkey }}
          operator: NotIn
          values:
            - {{ $labelvalue | quote }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
  parameters:
    volumes:
      - configMap
      - emptyDir
      - projected
      - secret
      - downwardAPI
      - persistentVolumeClaim
