name: End-to-end

on:
  push:
    branches:
      - 'aeddafali/troubleshooting-scripts-debug-2e2-pipeline'
  schedule:
  # Run at 4 and 10 GMT, basically "early morning" and "lunch"
  - cron: "0 4,10 * * *"

jobs:

  build-apps-image:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout compliantkubernetes-apps
      uses: actions/checkout@v3
      with:
        repository: elastisys/compliantkubernetes-apps
        ref: main
    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ghcr.io/elastisys/compliantkubernetes-apps-pipeline
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Build and push Docker images
      uses: docker/build-push-action@v3
      with:
        context: pipeline
        push: true
        tags: ghcr.io/elastisys/compliantkubernetes-apps-pipeline:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-to: type=gha,mode=max
        cache-from: type=gha


  apps:
    needs: [build-apps-image]
    runs-on: ubuntu-20.04
    container: ghcr.io/elastisys/compliantkubernetes-apps-pipeline:${{ github.sha }}
    strategy:
      fail-fast: false
      matrix:
        cluster:
          - sc
          - wc
    env:
      EXOSCALE_API_KEY: ${{ secrets.EXOSCALE_API_KEY }}
      EXOSCALE_API_SECRET: ${{ secrets.EXOSCALE_API_SECRET }}
      CK8S_CONFIG_PATH: ./apps/pipeline/config/exoscale
      CK8S_AUTO_APPROVE: true
    steps:
    ## TODO: We cannot currently use ck8s-kubespray since the terraform code
    ## for exoscale is not in the version we have in the submodule
    - name: Checkout ck8s-kubespray
      uses: actions/checkout@v3
      with:
        repository: elastisys/compliantkubernetes-kubespray
        # TODO: Should we use a specific commit here?
        ref: main
        submodules: recursive
        path: compliantkubernetes-kubespray
    - name: Checkout compliantkubernetes-apps
      uses: actions/checkout@v3
      with:
        repository: elastisys/compliantkubernetes-apps
        ref: main
        path: apps
        fetch-depth: 0 # Fetches all tags

    - name: Test apps
      run: ./apps/bin/ck8s test ${{ matrix.cluster }}
      env:
        PIPELINE: "true"
