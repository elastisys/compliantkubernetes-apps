name: End-to-end

on:
  push:
    branches:
      - 'aeddafali/troubleshooting-scripts-debug-2e2-pipeline'
  schedule:
  # Run at 4 and 10 GMT, basically "early morning" and "lunch"
  - cron: "0 4,10 * * *"

jobs:

  build-apps-image:
    runs-on: ubuntu-20.04
    steps:
    - name: Checkout compliantkubernetes-apps
      uses: actions/checkout@v3
      with:
        repository: elastisys/compliantkubernetes-apps
        ref: main
    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: ghcr.io/elastisys/compliantkubernetes-apps-pipeline
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Build and push Docker images
      uses: docker/build-push-action@v3
      with:
        context: pipeline
        push: true
        tags: ghcr.io/elastisys/compliantkubernetes-apps-pipeline:${{ github.sha }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-to: type=gha,mode=max
        cache-from: type=gha


  apps:
    needs: [build-apps-image]
    runs-on: ubuntu-20.04
    container: ghcr.io/elastisys/compliantkubernetes-apps-pipeline:${{ github.sha }}
    strategy:
      fail-fast: false
      matrix:
        cluster:
          - sc
          - wc
    env:
      EXOSCALE_API_KEY: ${{ secrets.EXOSCALE_API_KEY }}
      EXOSCALE_API_SECRET: ${{ secrets.EXOSCALE_API_SECRET }}
      CK8S_CONFIG_PATH: ./apps/pipeline/config/exoscale
      CK8S_AUTO_APPROVE: true
    steps:
    ## TODO: We cannot currently use ck8s-kubespray since the terraform code
    ## for exoscale is not in the version we have in the submodule
    - name: Checkout ck8s-kubespray
      uses: actions/checkout@v3
      with:
        repository: elastisys/compliantkubernetes-kubespray
        # TODO: Should we use a specific commit here?
        ref: main
        submodules: recursive
        path: compliantkubernetes-kubespray
    - name: Checkout compliantkubernetes-apps
      uses: actions/checkout@v3
      with:
        repository: elastisys/compliantkubernetes-apps
        ref: main
        path: apps
        fetch-depth: 0 # Fetches all tags

    - name: Import PGP key and configure GPG agent
      run: ./apps/pipeline/setup-pgp.bash
      env:
        PGP_KEY: ${{ secrets.PGP_KEY }}
        PGP_PASSPHRASE: ${{ secrets.PGP_PASSPHRASE }}

    - name: Prepare for apps
      env:
        S3_ACCESS_KEY: ${{ secrets.EXOSCALE_API_KEY }}
        S3_SECRET_KEY: ${{ secrets.EXOSCALE_API_SECRET }}
      run: |
        # Set public LB IP in the kubeconfig
        #control_plane_lb_ip_address="$(jq -r .outputs.control_plane_lb_ip_address.value $CK8S_CONFIG_PATH/pipeline-${{ matrix.cluster }}-config/terraform.tfstate)"
        #yq write --inplace "$CK8S_CONFIG_PATH/pipeline-${{ matrix.cluster }}-config/artifacts/admin.conf" clusters[0].cluster.server https://${control_plane_lb_ip_address}:6443
        # Copy to correct location and encrypt
        mkdir "$CK8S_CONFIG_PATH/.state"
        #cp "$CK8S_CONFIG_PATH/pipeline-${{ matrix.cluster }}-config/artifacts/admin.conf" "$CK8S_CONFIG_PATH/.state/kube_config_${{ matrix.cluster }}.yaml"
        sops --config "$CK8S_CONFIG_PATH/.sops.yaml" -e -i "$CK8S_CONFIG_PATH/.state/kube_config_${{ matrix.cluster }}.yaml"
        # Encrypt and set necessary secrets
        sops --config "$CK8S_CONFIG_PATH/.sops.yaml" -e -i "$CK8S_CONFIG_PATH/secrets.yaml"
        sops --config "$CK8S_CONFIG_PATH/.sops.yaml" --set "[\"objectStorage\"] {\"s3\": {\"accessKey\": \"${S3_ACCESS_KEY}\", \"secretKey\": \"${S3_SECRET_KEY}\"}}" "$CK8S_CONFIG_PATH/secrets.yaml"


    - name: Test apps
      if: always() && (steps.install-apps.outcome != 'cancelled' && steps.install-apps.outcome != 'skipped' && steps.install-apps.outcome != 'failure')
      run: ./apps/bin/ck8s test ${{ matrix.cluster }}
      env:
        PIPELINE: "true"
