name: release

on:
  pull_request:
    types:
      - closed
    branches:
      - release-[0-9]+.[0-9]+

jobs:
  release:
    if: github.event.pull_request.merged == true
    name: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Import GPG key
        id: import_tag
        run: |
          gpg --import <(echo "${PRIVATE_SIGNING_KEY}")
          git config --global user.signingkey "${SIGNING_KEY_ID}"
          git config --global user.name "${SIGNING_KEY_NAME}"
          git config --global user.email "${SIGNING_KEY_EMAIL}"
        env:
          PRIVATE_SIGNING_KEY: ${{ secrets.PRIVATE_SIGNING_KEY }}
          SIGNING_KEY_ID: ${{ vars.SIGNING_KEY_ID }}
          SIGNING_KEY_NAME: ${{ vars.SIGNING_KEY_NAME }}
          SIGNING_KEY_EMAIL: ${{ vars.SIGNING_KEY_EMAIL }}
      - name: Get series
        id: get_series
        run: echo "SERIES=$(echo "${{ github.ref_name }}" | sed 's/release-\(.*\.[0-9]*\)$/\1/')" >> "${GITHUB_OUTPUT}"
      - name: Create Signed Tag and Push
        id: create_tag
        run: |
          TAG_NAME="v$(echo "${{ github.head_ref }}" | sed 's/staging-\(.*\)$/\1/')"
          git config --get user.signingkey
          git commit -S --allow-empty -m "Release ${TAG_NAME}"
          git tag -s "${TAG_NAME}" -m "Release ${TAG_NAME}"
          git push --atomic origin "${{ github.ref_name}}" "${TAG_NAME}"
          echo "TAG_NAME=${TAG_NAME}" >> "${GITHUB_OUTPUT}"
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.create_tag.outputs.TAG_NAME }}
          body: |
            See [CHANGELOG](https://github.com/elastisys/compliantkubernetes-apps/blob/${{ github.ref_name }}/changelog/${{ steps.get_series.outputs.SERIES }}.md) for details.
          files: |
            public.signing.key
