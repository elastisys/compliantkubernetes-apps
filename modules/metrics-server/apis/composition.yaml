apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: metricsserver.modules.elastisys.com
spec:
  compositeTypeRef:
    apiVersion: modules.elastisys.com/v1alpha1
    kind: MetricsServer
  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources
        resources:
          - name: metrics-server
            base:
              apiVersion: helm.crossplane.io/v1beta1
              kind: Release
              metadata:
                name: metrics-server
              spec:
                providerConfigRef:
                  name: helm
                forProvider:
                  wait: true
                  namespace: kube-system
                  chart:
                    repository: https://kubernetes-sigs.github.io/metrics-server
                    name: metrics-server
                    version: "3.12.1"
                  values:
                    rbac:
                      create: true
                    # added just to keep only InternalIP as kubelet preferred address
                    defaultArgs:
                      - --cert-dir=/tmp
                      - --kubelet-preferred-address-types=InternalIP
                      - --kubelet-use-node-status-port
                      - --metric-resolution=30s
                    args:
                      - "--kubelet-insecure-tls"
                    # keeping the container port from the old chart
                    containerPort: 8443
                    # the pod failed to start due to a liveness probe timeout so we had to increase the period to 20
                    livenessProbe:
                      periodSeconds: 20
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.affinity
                toFieldPath: spec.forProvider.values.affinity
              - type: FromCompositeFieldPath
                fromFieldPath: spec.resources
                toFieldPath: spec.forProvider.values.resources
              - type: FromCompositeFieldPath
                fromFieldPath: spec.tolerations
                toFieldPath: spec.forProvider.values.tolerations
